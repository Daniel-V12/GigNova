@using Microsoft.AspNetCore.Http
﻿@using GigNovaModels.ViewModels
@using GigNovaModels.Models
@model CatalogViewModel
@{
    ViewData["Title"] = "ViewCatalogPage";
    Layout = "~/Views/Shared/MasterGuestPage.cshtml";
    string personId = Context.Session.GetString("person_id");
    string actor = Context.Session.GetString("actor");
    if (personId != null)
    {
        if (actor == "seller")
        {
            Layout = "~/Views/Shared/MasterSellerPage.cshtml";
        }
        else
        {
            Layout = "~/Views/Shared/MasterBuyerPage.cshtml";
        }
    }
    List<string> selectedCategories = new List<string>();
    if (Model != null)
    {
        if (Model.GigCategories != null)
        {
            string[] categories = Model.GigCategories.Split(',');
            foreach (string category in categories)
            {
                if (category != null)
                {
                    string trimmedCategory = category.Trim();
                    if (trimmedCategory != "")
                    {
                        selectedCategories.Add(trimmedCategory);
                    }
                }
            }
        }
    }
}
<link href="~/css/guest_pages/catalog_page.css" rel="stylesheet" />

<div class="catalog-container">
    <form method="get" asp-controller="Guest" asp-action="ViewCatalogPage">
        <div class="category-filters">
            <h2>Categories</h2>
            <div class="category-buttons">
                @if (Model != null)
                {
                    if (Model.Categories != null)
                    {
                        foreach (Category category in Model.Categories)
                        {
                            bool isSelected = false;
                            foreach (string selectedCategory in selectedCategories)
                            {
                                if (selectedCategory == category.Category_id)
                                {
                                    isSelected = true;
                                }
                            }

                            string activeClass = "";
                            if (isSelected)
                            {
                                activeClass = "active";
                            }

                            if (isSelected)
                            {
                                <label class="category-btn @activeClass">
                                    <input type="checkbox" value="@category.Category_id" checked />
                                    <span>@category.Category_name</span>
                                </label>
                            }
                            else
                            {
                                <label class="category-btn @activeClass">
                                    <input type="checkbox" value="@category.Category_id" />
                                    <span>@category.Category_name</span>
                                </label>
                            }
                        }
                    }
                }
            </div>
        </div>

        <div class="main-content">
            <aside class="sidebar">
                <div class="filter-section">
                    <h3>Budget</h3>
                    <div class="budget-inputs">
                        @if (Model != null && Model.min_price > 0)
                        {
                            <input type="number" name="min_price" placeholder="Min $" min="0" step="1" value="@Model.min_price">
                        }
                        else
                        {
                            <input type="number" name="min_price" placeholder="Min $" min="0" step="1">
                        }

                        @if (Model != null && Model.max_price > 0)
                        {
                            <input type="number" name="max_price" placeholder="Max $" min="0" step="1" value="@Model.max_price">
                        }
                        else
                        {
                            <input type="number" name="max_price" placeholder="Max $" min="0" step="1">
                        }
                    </div>
                </div>

                <div class="filter-section">
                    <h3>Delivery Time</h3>
                    <select name="delivery_time_id">
                        <option value="0">Any Time</option>
                        @if (Model != null)
                        {
                            if (Model.Delivery_Times != null)
                            {
                                foreach (Delivery_time deliveryTime in Model.Delivery_Times)
                                {
                                    int deliveryTimeId = Convert.ToInt32(deliveryTime.Delivery_time_id);
                                    if (Model.delivery_time_id == deliveryTimeId)
                                    {
                                        <option value="@deliveryTime.Delivery_time_id" selected>@deliveryTime.Delivery_time_name</option>
                                    }
                                    else
                                    {
                                        <option value="@deliveryTime.Delivery_time_id">@deliveryTime.Delivery_time_name</option>
                                    }
                                }
                            }
                        }
                    </select>
                </div>

                <div class="filter-section">
                    <h3>Seller Language</h3>
                    <select name="language_id">
                        <option value="0">All Languages</option>
                        @if (Model != null)
                        {
                            if (Model.Languages != null)
                            {
                                foreach (Language language in Model.Languages)
                                {
                                    int languageId = Convert.ToInt32(language.Language_id);
                                    if (Model.language_id == languageId)
                                    {
                                        <option value="@language.Language_id" selected>@language.Language_name</option>
                                    }
                                    else
                                    {
                                        <option value="@language.Language_id">@language.Language_name</option>
                                    }
                                }
                            }
                        }
                    </select>
                </div>

                <div class="filter-section">
                    <h3>Rating</h3>
                    <select name="min_rating">
                        <option value="0">All Ratings</option>
                        @for (int i = 5; i >= 1; i--)
                        {
                            if (Model != null && Model.min_rating == i)
                            {
                                <option value="@i" selected>@i stars & up</option>
                            }
                            else
                            {
                                <option value="@i">@i stars & up</option>
                            }
                        }
                    </select>
                </div>

                @if (Model != null)
                {
                    <input type="hidden" name="categories" id="categoriesInput" value="@Model.GigCategories" />
                }
                else
                {
                    <input type="hidden" name="categories" id="categoriesInput" value="" />
                }
                <input type="hidden" name="page" value="1" />

                <div class="actions-row">
                    <button type="submit" class="action-btn apply-btn">Apply Filters</button>
                    <a asp-controller="Guest" asp-action="ViewCatalogPage" class="action-btn clear-btn">Clear</a>
                </div>
            </aside>

            <div class="gigs-section">
                <div class="gigs-header">
                    @if (Model != null && Model.Gigs != null)
                    {
                        <h2 id="resultCount">Available Gigs (@Model.Gigs.Count on this page)</h2>
                    }
                    else
                    {
                        <h2 id="resultCount">Available Gigs (0 on this page)</h2>
                    }
                </div>

                <div class="gigs-grid" id="gigsGrid">
                    @if (Model != null && Model.Gigs != null && Model.Gigs.Count > 0)
                    {
                        for (int i = 0; i < Model.Gigs.Count; i++)
                        {
                            Gig gig = Model.Gigs[i];
                            <a class="gig-card" asp-controller="Guest" asp-action="ViewSelectedGig" asp-route-gig_id="@gig.Gig_id">
                                <div class="gig-image-wrap">
                                    <img class="gig-image" src="http://localhost:7059/Images/@gig.Gig_photo" alt="@gig.Gig_name" />
                                </div>
                                <div class="gig-info">
                                    <p class="gig-title">@gig.Gig_name</p>
                                    <p class="gig-description">@gig.Gig_description</p>
                                    @{
                                        string categoryNamesText = "";
                                        if (Model.GigCategoryNames != null && Model.GigCategoryNames.Count > i)
                                        {
                                            categoryNamesText = Model.GigCategoryNames[i];
                                        }

                                        if (categoryNamesText == "" && gig.Category_id != null && gig.Category_id != "" && Model.Categories != null)
                                        {
                                            foreach (Category category in Model.Categories)
                                            {
                                                if (category.Category_id == gig.Category_id)
                                                {
                                                    categoryNamesText = category.Category_name;
                                                }
                                            }
                                        }

                                        if (categoryNamesText != "")
                                        {
                                            <div class="gig-categories-wrap">
                                                @{
                                                    string[] gigCategories = categoryNamesText.Split(',');
                                                    foreach (string gigCategory in gigCategories)
                                                    {
                                                        if (gigCategory != null)
                                                        {
                                                            string categoryTrim = gigCategory.Trim();
                                                            if (categoryTrim != "")
                                                            {
                                                                <span class="gig-category-chip">@categoryTrim</span>
                                                            }
                                                        }
                                                    }
                                                }
                                            </div>
                                        }
                                    }
                                    <div class="gig-footer">
                                        <div class="gig-price">
                                            <span class="price-label">Starting at</span>
                                            <span class="price-value">$@gig.Gig_price</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <h3>No gigs match your filters.</h3>
                            <p>Try broadening the filters or clearing them.</p>
                        </div>
                    }
                </div>

                @if (Model != null && Model.TotalPages > 1)
                {
                    <div class="pagination">
                        @if (Model.Page > 1)
                        {
                            <a class="page-btn"
                               asp-controller="Guest"
                               asp-action="ViewCatalogPage"
                               asp-route-categories="@Model.GigCategories"
                               asp-route-page="@(Model.Page - 1)"
                               asp-route-min_price="@Model.min_price"
                               asp-route-max_price="@Model.max_price"
                               asp-route-delivery_time_id="@Model.delivery_time_id"
                               asp-route-language_id="@Model.language_id"
                               asp-route-min_rating="@Model.min_rating">Previous</a>
                        }
                        else
                        {
                            <span class="page-btn disabled">Previous</span>
                        }

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            string pageClass = "page-btn";
                            if (Model.Page == i)
                            {
                                pageClass = "page-btn active";
                            }

                            <a class="@pageClass"
                               asp-controller="Guest"
                               asp-action="ViewCatalogPage"
                               asp-route-categories="@Model.GigCategories"
                               asp-route-page="@i"
                               asp-route-min_price="@Model.min_price"
                               asp-route-max_price="@Model.max_price"
                               asp-route-delivery_time_id="@Model.delivery_time_id"
                               asp-route-language_id="@Model.language_id"
                               asp-route-min_rating="@Model.min_rating">@i</a>
                        }

                        @if (Model.Page < Model.TotalPages)
                        {
                            <a class="page-btn"
                               asp-controller="Guest"
                               asp-action="ViewCatalogPage"
                               asp-route-categories="@Model.GigCategories"
                               asp-route-page="@(Model.Page + 1)"
                               asp-route-min_price="@Model.min_price"
                               asp-route-max_price="@Model.max_price"
                               asp-route-delivery_time_id="@Model.delivery_time_id"
                               asp-route-language_id="@Model.language_id"
                               asp-route-min_rating="@Model.min_rating">Next</a>
                        }
                        else
                        {
                            <span class="page-btn disabled">Next</span>
                        }
                    </div>
                }
            </div>
        </div>
    </form>
</div>

<script>
    (function () {
        var categoryInputs = document.querySelectorAll('.category-btn input[type="checkbox"]');
        var categoriesInput = document.getElementById('categoriesInput');

        function updateCategories() {
            var selected = [];
            for (var i = 0; i < categoryInputs.length; i++) {
                if (categoryInputs[i].checked) {
                    selected.push(categoryInputs[i].value);
                }
            }
            categoriesInput.value = selected.join(',');
        }

        for (var i = 0; i < categoryInputs.length; i++) {
            categoryInputs[i].addEventListener('change', updateCategories);
        }

        updateCategories();
    })();
</script>

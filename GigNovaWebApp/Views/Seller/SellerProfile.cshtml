@model GigNovaModels.ViewModels.SellerProfileViewModel
@{
    ViewData["Title"] = "SellerProfile";
    Layout = "~/Views/Shared/MasterSellerPage.cshtml";

    string joinDate = "Unknown";
    string sellerDisplayName = "";
    string sellerBio = "";
    string sellerAvatar = "";
    string username = "";
    string email = "";
    string birthdate = "";
    bool isLinked = false;

    if (Model != null)
    {
        if (Model.seller != null)
        {
            if (Model.seller.Seller_display_name != null)
            {
                sellerDisplayName = Model.seller.Seller_display_name;
            }
            if (Model.seller.Seller_description != null)
            {
                sellerBio = Model.seller.Seller_description;
            }
            if (Model.seller.Seller_avatar != null)
            {
                sellerAvatar = Model.seller.Seller_avatar;
            }
            isLinked = Model.seller.Seller_is_linked;
        }

        if (Model.seller_person != null)
        {
            if (Model.seller_person.Person_username != null)
            {
                username = Model.seller_person.Person_username;
            }
            if (Model.seller_person.Person_email != null)
            {
                email = Model.seller_person.Person_email;
            }
            if (Model.seller_person.Person_birthdate != null)
            {
                birthdate = Model.seller_person.Person_birthdate;
            }
            if (Model.seller_person.Person_join_date != null && Model.seller_person.Person_join_date != "")
            {
                joinDate = Model.seller_person.Person_join_date;
            }
        }
    }

    string avatarUrl = "";
    string sellerAvatarLower = sellerAvatar.ToLower();
    bool hasValidAvatar = sellerAvatarLower.EndsWith(".jpg") ||
                          sellerAvatarLower.EndsWith(".jpeg") ||
                          sellerAvatarLower.EndsWith(".png") ||
                          sellerAvatarLower.EndsWith(".gif") ||
                          sellerAvatarLower.EndsWith(".webp");
    if (hasValidAvatar)
    {
        avatarUrl = "http://localhost:7059/Images/" + sellerAvatar;
    }

}

<link href="~/css/seller_pages/sellerprofile_page.css" rel="stylesheet" />
<div class="profile-container">
    <div class="profile-header">
        <h1 class="profile-title">Seller Profile</h1>
        <p class="join-date">Member since @joinDate</p>
    </div>

    @if (TempData["SellerProfileMessage"] != null)
    {
        <div class="profile-message">@TempData["SellerProfileMessage"]</div>
    }

    <form asp-controller="Seller" asp-action="SellerProfile" method="post" enctype="multipart/form-data">
        <div class="profile-section">
            <h2 class="section-title">Seller Information</h2>

            <div class="avatar-section">
                <div class="avatar-container">
                    <div class="avatar" id="avatarPreview">
                        @if (avatarUrl != "")
                        {
                            <img src="@avatarUrl" alt="Seller Avatar" />
                        }
                        else
                        {
                            <span>👤</span>
                        }
                    </div>
                </div>
                <label for="sellerAvatarFile" class="upload-avatar-btn">Upload Profile Picture</label>
                <input type="file" id="sellerAvatarFile" name="sellerAvatarFile" class="file-input" accept="image/*">
            </div>

            <div class="form-group">
                <label class="form-label" for="Seller_display_name">Display Name</label>
                <input type="text"
                       id="Seller_display_name"
                       name="seller.Seller_display_name"
                       class="form-input"
                       value="@sellerDisplayName"
                       placeholder="Enter your display name"
                       required>
            </div>

            <div class="form-group">
                <label class="form-label" for="Seller_description">Bio</label>
                <textarea id="Seller_description"
                          name="seller.Seller_description"
                          class="form-textarea"
                          placeholder="Tell clients about your skills and experience..."
                          maxlength="500">@sellerBio</textarea>
                <div class="char-count"><span id="charCount">0</span>/500 characters</div>
            </div>

            <input type="hidden" name="seller.Seller_is_linked" value="@isLinked.ToString().ToLower()" />

            <button class="edit-button" type="submit">Save Changes</button>
        </div>
    </form>

    <div class="profile-section">
        <h2 class="section-title">Personal Information</h2>

        <div class="form-group">
            <label class="form-label" for="username">Username</label>
            <input type="text" id="username" class="form-input" value="@username" readonly>
            <p class="info-text">Username cannot be changed</p>
        </div>

        <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email" id="email" class="form-input" value="@email" readonly>
            <p class="info-text">Email cannot be changed</p>
        </div>

        <div class="form-group">
            <label class="form-label" for="passwordDisplay">Password</label>
            <input type="password" id="passwordDisplay" class="form-input" value="********" readonly>
            <p class="info-text">Use the button below to change password</p>
            <button type="button" class="change-password-button" style="margin-top:12px;padding:10px 18px;background:transparent;color:white;border:2px solid rgba(255,255,255,0.7);border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;" onclick="document.getElementById('passwordModalOverlay').style.display='flex'">Change Password</button>
        </div>

        <div class="form-group">
            <label class="form-label" for="birthdate">Birthdate</label>
            <input type="text" id="birthdate" class="form-input" value="@birthdate" readonly>
            <p class="info-text">Birthdate cannot be changed</p>
        </div>
    </div>
</div>

<div id="passwordModalOverlay" class="password-modal-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);justify-content:center;align-items:center;z-index:2000;padding:20px;" onclick="closePasswordModal(event)">
    <div class="password-modal" style="width:100%;max-width:500px;background:#2f3a58;border:2px solid rgba(255,255,255,0.2);border-radius:14px;padding:28px;box-shadow:0 12px 30px rgba(0,0,0,0.4);">
        <h3>Change Password</h3>
        <form asp-controller="Seller" asp-action="ChangePassword" method="post">
            <div class="form-group">
                <label class="form-label" for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" class="form-input" required>
            </div>
            <div class="password-modal-buttons">
                <button type="submit" class="edit-button">Save Password</button>
                <button type="button" class="cancel-password-button" onclick="document.getElementById('passwordModalOverlay').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var bio = document.getElementById('Seller_description');
        var count = document.getElementById('charCount');
        if (bio && count) {
            var updateCount = function () { count.textContent = bio.value.length; };
            bio.addEventListener('input', updateCount);
            updateCount();
        }

        var avatarInput = document.getElementById('sellerAvatarFile');
        var preview = document.getElementById('avatarPreview');
        if (avatarInput && preview) {
            avatarInput.addEventListener('change', function () {
                if (!avatarInput.files || avatarInput.files.length === 0) {
                    return;
                }

                var file = avatarInput.files[0];
                var reader = new FileReader();
                reader.onload = function (e) {
                    preview.innerHTML = '<img src="' + e.target.result + '" alt="Seller Avatar Preview" />';
                };
                reader.readAsDataURL(file);
            });
        }

    });


    function closePasswordModal(event) {
        if (event) {
            if (event.target.id != "passwordModalOverlay") {
                return;
            }
        }
        document.getElementById("passwordModalOverlay").style.display = "none";
    }
</script>
